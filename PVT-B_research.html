<!DOCTYPE html>
<html lang="en">
<!-- 
  v0.1 - works for me, shared for learning.
  Feel free to use/modify. - @AshXiong, 2025
-->

<head>
    <meta charset="UTF-8">
    <title>PVT-B Task</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            /* overflow: hidden; */
            overflow: auto;
        }

        #screen {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #timer {
            font-size: 80px;
            color: rgb(255, 255, 0);
        }

        #feedback {
            font-size: 80px;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
        }

        #remainingTime {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 20px;
            color: lime;
        }

        #instructions {
            font-size: 24px;
            max-width: 800px;
            margin: auto;
            padding: 20px;
        }

        button {
            font-size: 24px;
            padding: 10px 20px;
            margin-top: 20px;
        }

        #stimulus-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 100px;
            border: 3px solid red;
            display: none;
            pointer-events: none;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .debug #feedback,
        .debug #remainingTime,
        .debug #debug-stats {
            display: block;
        }

        #feedback,
        #remainingTime,
        #debug-stats {
            display: none;
        }
    </style>
</head>

<!-- 当取消<body class="debug">注释并将body注释时进入测试模式 -->
<!-- <body class="debug"> -->

<body>


    <div id="remainingTime">3:00</div>
    <div id="stimulus-frame"></div>
    <!-- 在 #screen 之前添加 -->
    <div id="consent-screen" style="max-width: 800px; margin: auto; padding: 20px;">
        <div id="header-info" style="padding: 20px; text-align: center;">
            <h1>Brief Psychomotor Vigilance Test (PVT-B)</h1>
            <p><em>Based on the 3-minute Psychomotor Vigilance Task (PVT-B) by Basner et al. (2011), adapted from Dinges
                    &
                    Powell (1985).</em></p>
        </div>
        <h2>Consent to Participate</h2>
        <p>By clicking "I Agree" below, you confirm that you understand this test measures your reaction time and
            attention.
            Your data will be recorded for research purposes. You may stop the experiment at any time.</p>
        <p><strong>Data collected:</strong> Reaction times, correct responses, lapses, and commission errors. Your
            performance may be affected by your sleep, fatigue, and environmental factors, as demonstrated in
            spaceflight research.</p>
        <label>
            <input type="checkbox" id="consent-checkbox"> I have read and understood the information above and agree to
            participate
        </label>
        <br><br>
        <button id="consent-button" disabled>Start Experiment</button>



        <div id="references"
            style="max-width: 800px; margin: 50px auto; padding: 20px; font-size: 14px; border-top: 1px solid #444;">
            <h3>References</h3>
            <ul style="text-align: left;">
                <li>Basner, M., Mollicone, D., & Dinges, D. F. (2011). Validity and sensitivity of a brief Psychomotor
                    Vigilance
                    Test (PVT-B) to total and partial sleep deprivation. <em>Acta Astronautica, 69</em>(9-10), 949–959.
                    https://doi.org/10.1016/j.actaastro.2011.07.015</li>
                <li>Dinges, D. F., & Powell, J. W. (1985). Microcomputer analyses of performance on a portable, simple
                    visual RT
                    task during sustained operations. <em>Behavior Research Methods, Instruments, & Computers,
                        17</em>(6),
                    652–655.
                </li>
                <li>Wilkinson, R. T., & Houghton, D. (1982). Field test of arousal: A portable reaction timer with data
                    storage.
                    <em>Human Factors, 24</em>(4), 487–493. https://doi.org/10.1177/001872088202400409
                </li>
            </ul>

            <h3>Data Output Format</h3>
            <table border="1" style="width: 100%; border-collapse: collapse; text-align: left;">
                <tr>
                    <th>Column</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td>Test End Time</td>
                    <td>Date and time when the test was completed</td>
                </tr>
                <tr>
                    <td>Average RT (ms)</td>
                    <td>Average reaction time for correct responses</td>
                </tr>
                <tr>
                    <td>Total Trials</td>
                    <td>Total number of trials attempted</td>
                </tr>
                <tr>
                    <td>Lapses (>500ms)</td>
                    <td>Number of responses slower than 500ms</td>
                </tr>
                <tr>
                    <td>Commissions (too early)</td>
                    <td>Number of premature responses</td>
                </tr>
            </table>

            <footer style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #444;">
                <p>This implementation is inspired by the <a
                        href="https://www.psytoolkit.org/experiment-library/pvtb.html" target="_blank"
                        style="color: #88f;">PsyToolkit PVT-B demo</a>.<br>
                    Code adapted for educational/research use under open-access principles.</p>
            </footer>

        </div>



    </div>
    <div id="screen" style="display: none;">
        <!-- 替换原有的 #instructions 内容 -->
        <div id="instructions">
            <h2>Instructions</h2>
            <p>A red box will appear on the screen. Wait for a yellow number to appear inside it.</p>
            <p>As soon as you see the number, press the <strong>SPACE</strong> key as quickly as possible.</p>
            <p>Do not press the spacebar when no number is shown — this counts as an error.</p>
            <p>The test lasts 3 minutes. Try to stay focused throughout.</p>
            <p>Press <strong>SPACE</strong> to start the task. Try to stay focused, as your performance reflects your
                current level of alertness.</p>
        </div>
        <div id="task" style="display:none;">
            <div id="stimulus-container">
                <div id="timer"></div>
            </div>
        </div>
    </div>
    <div id="feedback"></div>
    <div id="debug-stats" style="position: absolute; top: 20px; left: 20px; font-size: 20px; color: lime;">
        Commissions: <span id="commissions-count">0</span><br>
        Lapses: <span id="lapses-count">0</span>
    </div>

    <script>
        const TOTAL_EXP = 180000; // 3 minutes
        // const TOTAL_EXP = 10000;
        const MIN_RT = 100;       // minimum RT
        const LAPSE_TIME = 500;   // lapse threshold
        let correctRTs = [];
        let nTrials = 0;
        let nLapses = 0;
        let nCommissions = 0;
        let experimentBeginTime;
        let trialBeginTime;
        let stimulusPresent = false;
        let keyAllowed = false;
        let timeoutID = null;
        let trialActive = false;

        const timerEl = document.getElementById("timer");
        const feedbackEl = document.getElementById("feedback");
        const taskEl = document.getElementById("task");
        const instructionsEl = document.getElementById("instructions");
        const remainingTimeEl = document.getElementById("remainingTime");
        // 获取红色边框元素
        const stimulusFrameEl = document.getElementById("stimulus-container");

        const consentScreen = document.getElementById("consent-screen");
        const consentCheckbox = document.getElementById("consent-checkbox");
        const consentButton = document.getElementById("consent-button");

        // 添加事件监听器
        consentCheckbox.addEventListener("change", function () {
            consentButton.disabled = !this.checked;
        });

        consentButton.addEventListener("click", function () {
            consentScreen.style.display = "none";
            document.getElementById("screen").style.display = "flex";
            instructionsEl.style.display = "block";
        });


        document.addEventListener("keydown", function (e) {
            if (e.code !== "Space") return;

            // 如果在说明页面，空格键开始任务
            if (!trialActive && instructionsEl.style.display === "block") {
                e.preventDefault(); // 防止默认行为
                startTask();
                return;
            }

            // 如果试验正在进行中
            if (trialActive) {
                e.preventDefault(); // 防止默认行为（如页面滚动）
                if (keyAllowed) {
                    const rt = performance.now() - trialBeginTime;
                    handleResponse(rt);
                } else {
                    handleResponse(); // 过早按键
                }
            }
        });

        function startTask() {

            instructionsEl.style.display = "none";
            taskEl.style.display = "flex";
            stimulusFrameEl.style.display = "block";
            experimentBeginTime = performance.now();
            runTrial();
            updateRemainingTime();
            updateDebugStats(); // 启动调试信息的自动更新
        }

        function runTrial() {
            if (performance.now() - experimentBeginTime >= TOTAL_EXP) {
                endTask();
                return;
            }

            trialActive = true;
            nTrials++;
            stimulusPresent = false;
            keyAllowed = false;
            feedbackEl.textContent = "";
            timerEl.textContent = "";

            const randomDelay = Math.floor(Math.random() * 3000); // 0–3000 ms

            timeoutID = setTimeout(() => {
                trialBeginTime = performance.now();
                stimulusPresent = true;
                keyAllowed = true;
                updateTimer();
            }, randomDelay);
        }

        function updateTimer() {
            if (!stimulusPresent) return;
            const elapsed = performance.now() - trialBeginTime;
            timerEl.textContent = Math.floor(elapsed); // 或 Math.round

            if (elapsed < 1000) {
                setTimeout(updateTimer, 1); // 尝试每 1ms 更新（实际最小约 1–2ms）
            } else {
                trialTimeOut();
                timerEl.textContent = "1000"; // 显示1000
                setTimeout(runTrial, 1000);
            }
        }

        function handleResponse(rt) {
            clearTimeout(timeoutID);
            trialActive = false;
            // 停止计时器刷新并清除黄色数字
            stimulusPresent = false;
            timerEl.textContent = ""; // 清除黄色数字

            if (rt < MIN_RT || rt == undefined) {
                handleCommission();
                // 过早按键时显示默认值50
                timerEl.textContent = "50";
            } else if (rt > LAPSE_TIME) {
                handleLapse();
                text = Math.floor(rt)
                timerEl.textContent = text;
            } else {
                correctRTs.push(rt);
                text = Math.floor(rt)
                timerEl.textContent = text;
            }
            setTimeout(runTrial, 1000);
            return
        }

        function handleCommission() {
            clearTimeout(timeoutID);
            trialActive = false;
            nCommissions++;
            showFeedback("TOO EARLY", "red");
        }

        function handleLapse() {
            clearTimeout(timeoutID);
            trialActive = false;
            nLapses++;
            showFeedback("TOO SLOW", "red");
        }

        function trialTimeOut() {
            clearTimeout(timeoutID);
            trialActive = false;
            nLapses++;
            showFeedback("Time Out", "red");
        }


        function showFeedback(text, color) {
            feedbackEl.textContent = text;
            feedbackEl.style.color = color;
        }

        function updateRemainingTime() {
            const elapsed = performance.now() - experimentBeginTime;
            const remaining = Math.max(0, TOTAL_EXP - elapsed);
            const seconds = Math.floor(remaining / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            remainingTimeEl.textContent = `${minutes}:${secs < 10 ? '0' + secs : secs}`;
            if (remaining > 0) {
                requestAnimationFrame(updateRemainingTime);
            }
        }
        function updateDebugStats() {
            if (document.body.classList.contains('debug')) {
                document.getElementById("commissions-count").textContent = nCommissions;
                document.getElementById("lapses-count").textContent = nLapses;
            }
            // 如果处于调试模式且任务正在进行中，则继续更新
            if (document.body.classList.contains('debug') && experimentBeginTime) {
                requestAnimationFrame(updateDebugStats);
            }
        }

        function generateResultData() {
            const avgRT = correctRTs.length > 0 ? (correctRTs.reduce((a, b) => a + b, 0) / correctRTs.length).toFixed(2) : 0;

            // 使用当前时间作为结束时间
            const testEndTime = new Date().toLocaleString('zh-CN', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });

            // 修改为所需的CSV格式
            const resultHeader = "Test End Time,Average RT (ms),Total Trials,Lapses (>500ms),Commissions (too early)";
            const resultData = `${testEndTime},${avgRT},${nTrials},${nLapses},${nCommissions}`;

            return {
                header: resultHeader,
                data: resultData,
                display: {
                    testEndTime: testEndTime,
                    avgRT: avgRT,
                    nTrials: nTrials,
                    nLapses: nLapses,
                    nCommissions: nCommissions
                }
            };
        }

        function generateResultHTML(result) {
            const displayData = `
    Test End Time: ${result.display.testEndTime}
    Average RT: ${result.display.avgRT} ms
    Total Trials: ${result.display.nTrials}
    Lapses (>500ms): ${result.display.nLapses}
    Commissions (too early): ${result.display.nCommissions}
  `;

            return `
    <h2>Task Completed</h2>
    <pre id="resultData">${displayData}</pre>
    <button onclick="copyDataAsCSV()">Copy Data</button>
    <button onclick="location.reload()">Restart</button>
    <div id="csvData" style="display:none">${result.header}\n${result.data}</div>
  `;
        }

        function endTask() {
            debugStatsActive = false; // 停止更新调试统计信息
            taskEl.style.display = "none";

            // 生成结果数据
            const result = generateResultData();

            // 生成并显示结果HTML
            const resultHTML = generateResultHTML(result);

            document.getElementById("screen").innerHTML = resultHTML;
        }


        function copyDataAsCSV() {
            const csvData = document.getElementById("csvData").innerText;
            navigator.clipboard.writeText(csvData).then(() => {
                alert("CSV data copied to clipboard!");
            }).catch(err => {
                console.error("Failed to copy: ", err);
                alert("Failed to copy data.");
            });
        }
    </script>
</body>

</html>