<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>PVT-B Task</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    #screen {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #timer {
      font-size: 80px;
      color: rgb(255, 255, 0);
    }

    #feedback {
      font-size: 80px;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
    }

    #remainingTime {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 20px;
      color: lime;
    }

    #instructions {
      font-size: 24px;
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }

    button {
      font-size: 18px;
      padding: 12px 24px;
      margin: 10px;
      border: 1px solid #ddd;
      background: #fff;
      color: #333;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 4px;
      min-width: 120px;
    }

    /* 结果页面按钮特殊样式 */
    .result-buttons button {
      padding: 12px 25px;
      margin: 0 10px;
      min-width: 150px;
    }


    #resultData {
      font-size: 24px;
      line-height: 1.6;
      margin: 20px 0;
      white-space: pre-wrap;
      text-align: left;
      max-width: 800px;
      padding: 20px;
      background-color: #333;
      border-radius: 8px;
    }

    .result-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    .result-title {
      font-size: 32px;
      margin-bottom: 20px;
    }

    .result-buttons {
      margin-top: 20px;
    }

    button {
      font-size: 20px;
      padding: 12px 24px;
      margin: 0 10px;
      cursor: pointer;
    }


    #stimulus-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 250px;
      height: 100px;
      border: 3px solid red;
      display: none;
      pointer-events: none;
      z-index: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .debug #feedback,
    .debug #remainingTime,
    .debug #debug-stats {
      display: block;
    }

    #feedback,
    #remainingTime,
    #debug-stats {
      display: none;
    }
  </style>
</head>


<!-- <body class="debug"> -->

<body>
  <div id="remainingTime">3:00</div>
  <div id="stimulus-frame"></div>
  <div id="screen">
    <div id="instructions">
      <p>当黄色数字出现时，请尽快按<strong>空格键</strong>、<strong>点击</strong>或<strong>触摸</strong>屏幕。</p>
      <p>不要在数字出现之前按键。</p>
      <p>点击空格或按钮开始测试</p>
      <button id="startButton">开始任务</button>
    </div>
    <div id="task" style="display:none;">
      <div id="stimulus-container">
        <div id="timer"></div>
      </div>
    </div>
  </div>
  <div id="feedback"></div>
  <div id="debug-stats" style="position: absolute; top: 20px; left: 20px; font-size: 20px; color: lime;">
    Commissions: <span id="commissions-count">0</span><br>
    Lapses: <span id="lapses-count">0</span>
  </div>

  <script>
    const TOTAL_EXP = 180000; // 3 minutes
    // const TOTAL_EXP = 5000;
    const MIN_RT = 100;       // minimum RT
    const LAPSE_TIME = 500;   // lapse threshold
    let correctRTs = [];
    let nTrials = 0;
    let nLapses = 0;
    let nCommissions = 0;
    let experimentBeginTime;
    let trialBeginTime;
    let stimulusPresent = false;
    let keyAllowed = false;
    let timeoutID = null;
    let trialActive = false;
    let touchHandled = false;

    const timerEl = document.getElementById("timer");
    const feedbackEl = document.getElementById("feedback");
    const taskEl = document.getElementById("task");
    const instructionsEl = document.getElementById("instructions");
    const remainingTimeEl = document.getElementById("remainingTime");
    // 获取红色边框元素
    const stimulusFrameEl = document.getElementById("stimulus-container");

    // 统一通过按钮开始任务
    startButton.addEventListener("click", function () {
      startTask();
    });

    document.addEventListener("keydown", function (e) {
      if (e.code === "Space" && instructionsEl.style.display !== "none") {
        e.preventDefault(); // 防止页面滚动
        startTask();
      }
      else if (e.code === "Space" && keyAllowed && trialActive) {
        const rt = performance.now() - trialBeginTime;
        handleResponse(rt);
      } else if (e.code === "Space" && !stimulusPresent && trialActive) {
        handleResponse();
      }
    });
    // 修改触屏事件处理
    document.addEventListener("touchstart", function (e) {

      // 标记触摸事件已被处理
      touchHandled = true;

      if (keyAllowed && trialActive) {
        const rt = performance.now() - trialBeginTime;
        handleResponse(rt);
        return;
      }
      // 检查是否在任务进行中但刺激尚未出现
      else if (!stimulusPresent && trialActive) {
        handleResponse();
        return;
      }
    });
    // 修改鼠标点击事件处理
    document.addEventListener("click", function (e) {
      // 如果点击的是开始按钮，不处理为过早反应
      if (e.target.closest('#startButton')) {
        return;
      }

      // 如果触摸事件已被处理，则忽略点击事件
      if (touchHandled) {
        touchHandled = false; // 重置标志
        return;
      }
      // 检查是否在任务进行中且允许按键
      if (keyAllowed && trialActive) {
        const rt = performance.now() - trialBeginTime;
        handleResponse(rt);
        return;
      }
      // 检查是否在任务进行中但刺激尚未出现
      else if (!stimulusPresent && trialActive) {
        handleResponse();
        return;
      }
    });

    function startTask() {
      instructionsEl.style.display = "none";
      taskEl.style.display = "flex";
      stimulusFrameEl.style.display = "block";
      experimentBeginTime = performance.now();
      runTrial();
      updateRemainingTime();
      updateDebugStats(); // 启动调试信息的自动更新
    }

    function runTrial() {
      if (performance.now() - experimentBeginTime >= TOTAL_EXP) {
        endTask();
        return;
      }

      trialActive = true;
      nTrials++;
      stimulusPresent = false;
      keyAllowed = false;
      feedbackEl.textContent = "";
      timerEl.textContent = "";

      const randomDelay = Math.floor(Math.random() * 3000); // 0–3000 ms

      timeoutID = setTimeout(() => {
        trialBeginTime = performance.now();
        stimulusPresent = true;
        keyAllowed = true;
        updateTimer();
      }, randomDelay);
    }

    function updateTimer() {
      if (!stimulusPresent) return;
      const elapsed = performance.now() - trialBeginTime;
      timerEl.textContent = Math.floor(elapsed); // 或 Math.round

      if (elapsed < 30000) {
        setTimeout(updateTimer, 10); // 尝试每 10ms 更新
      } else {
        trialTimeOut();
        timerEl.textContent = "30000"; // 显示1000
        setTimeout(runTrial, 1000);
      }
    }

    function handleResponse(rt) {
      clearTimeout(timeoutID);
      trialActive = false;
      // 停止计时器刷新并清除黄色数字
      stimulusPresent = false;
      timerEl.textContent = ""; // 清除黄色数字

      if (rt < MIN_RT || rt == undefined) {
        handleCommission();
        // 过早按键时显示默认值50
        timerEl.textContent = "50";
      } else if (rt > LAPSE_TIME) {
        handleLapse();
        text = Math.floor(rt)
        timerEl.textContent = text;
      } else {
        correctRTs.push(rt);
        text = Math.floor(rt)
        timerEl.textContent = text;
      }
      setTimeout(runTrial, 1000);
      return
    }

    function handleCommission() {
      clearTimeout(timeoutID);
      trialActive = false;
      nCommissions++;
      showFeedback("TOO EARLY", "red");
    }

    function handleLapse() {
      clearTimeout(timeoutID);
      trialActive = false;
      nLapses++;
      showFeedback("TOO SLOW", "red");
    }

    function trialTimeOut() {
      clearTimeout(timeoutID);
      trialActive = false;
      nLapses++;
      showFeedback("Time Out", "red");
    }


    function showFeedback(text, color) {
      feedbackEl.textContent = text;
      feedbackEl.style.color = color;
    }

    function updateRemainingTime() {
      const elapsed = performance.now() - experimentBeginTime;
      const remaining = Math.max(0, TOTAL_EXP - elapsed);
      const seconds = Math.floor(remaining / 1000);
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      remainingTimeEl.textContent = `${minutes}:${secs < 10 ? '0' + secs : secs}`;
      if (remaining > 0) {
        requestAnimationFrame(updateRemainingTime);
      }
    }
    function updateDebugStats() {
      if (document.body.classList.contains('debug')) {
        document.getElementById("commissions-count").textContent = nCommissions;
        document.getElementById("lapses-count").textContent = nLapses;
      }
      // 如果处于调试模式且任务正在进行中，则继续更新
      if (document.body.classList.contains('debug') && experimentBeginTime) {
        requestAnimationFrame(updateDebugStats);
      }
    }

    function generateResultData() {
      const avgRT = correctRTs.length > 0 ? (correctRTs.reduce((a, b) => a + b, 0) / correctRTs.length).toFixed(2) : 0;

      // 使用当前时间作为结束时间
      const testEndTime = new Date().toLocaleString('zh-CN', {
        year: 'numeric',
        month: 'numeric',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });

      // 修改为所需的CSV格式
      const resultHeader = "Test End Time,Average RT (ms),Total Trials,Lapses (>500ms),Commissions (too early)";
      const resultData = `${testEndTime},${avgRT},${nTrials},${nLapses},${nCommissions}`;

      return {
        header: resultHeader,
        data: resultData,
        display: {
          testEndTime: testEndTime,
          avgRT: avgRT,
          nTrials: nTrials,
          nLapses: nLapses,
          nCommissions: nCommissions
        }
      };
    }

    function generateResultHTML(result) {
      const displayData = `
    测试时间: ${result.display.testEndTime}
    平均反应时间: ${result.display.avgRT} ms
    总测试次数: ${result.display.nTrials}
    过慢次数(>500ms): ${result.display.nLapses}
    过早次数: ${result.display.nCommissions}
  `;

      return `
<div class="result-container">
  <h2 class="result-title">任务完成</h2>
  <pre id="resultData">${displayData}</pre>
  <div class="result-buttons">
    <button onclick="copyDataAsCSV()">复制数据</button>
    <button onclick="location.reload()">重新开始</button>
  </div>
  <div id="csvData" style="display:none">${result.header}\n${result.data}</div>
</div>
`;
    }

    function endTask() {
      debugStatsActive = false; // 停止更新调试统计信息
      taskEl.style.display = "none";

      // 生成结果数据
      const result = generateResultData();

      // 生成并显示结果HTML
      const resultHTML = generateResultHTML(result);

      document.getElementById("screen").innerHTML = resultHTML;
    }


    function copyDataAsCSV() {
      const csvData = document.getElementById("csvData").innerText;
      navigator.clipboard.writeText(csvData).then(() => {
        alert("CSV data copied to clipboard!");
      }).catch(err => {
        console.error("Failed to copy: ", err);
        alert("Failed to copy data.");
      });
    }
  </script>
</body>

</html>